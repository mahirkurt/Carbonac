services:
  redis:
    image: redis:7.2-alpine
    container_name: carbonac-redis
    command: ["redis-server", "/usr/local/etc/redis/redis.conf"]
    volumes:
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
  api:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
    container_name: carbonac-api
    env_file:
      - .env
    environment:
      - PORT=3001
      - REDIS_URL=redis://redis:6379
      - JOB_QUEUE_NAME=carbonac-jobs
    ports:
      - "3001:3001"
    healthcheck:
      test: ["CMD", "node", "scripts/redis-healthcheck.js"]
      interval: 30s
      timeout: 10s
      retries: 3
    volumes:
      - output-data:/app/output
      - temp-data:/app/temp
    profiles:
      - api
  worker:
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
      args:
        INSTALL_TYPST: "0"
        INSTALL_QUARTO: "0"
    container_name: carbonac-worker
    env_file:
      - .env
    environment:
      - REDIS_URL=redis://redis:6379
      - JOB_QUEUE_NAME=carbonac-jobs
      - PUPPETEER_SKIP_DOWNLOAD=1
      - PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
    healthcheck:
      test: ["CMD", "node", "backend/scripts/redis-healthcheck.js"]
      interval: 30s
      timeout: 10s
      retries: 3
    volumes:
      - output-data:/app/output
      - temp-data:/app/temp
    profiles:
      - worker

volumes:
  output-data:
  temp-data:
  redis-data:
