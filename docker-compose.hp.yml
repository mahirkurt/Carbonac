# docker-compose.hp.yml
#
# HP Thin Client â€” Optimized for worker-only mode
#
# Recommended: Redis + API run on Raspberry Pi. HP runs only the worker.
# Worker connects to Pi's Redis over Tailscale via REDIS_URL in .env.
#
# Usage:
#   Worker only (Pi handles Redis + API):
#     docker compose -f docker-compose.hp.yml --profile worker up -d
#
#   Standalone / development (all services on HP):
#     docker compose -f docker-compose.hp.yml --profile full up -d

services:
  redis:
    image: redis:7.2-alpine
    container_name: carbonac-redis
    command: ["redis-server", "/usr/local/etc/redis/redis.conf"]
    volumes:
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - redis-data:/data
    deploy:
      resources:
        limits:
          memory: 256m
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    profiles:
      - redis
      - full

  api:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
    container_name: carbonac-api
    env_file:
      - .env
    environment:
      - PORT=3001
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - JOB_QUEUE_NAME=carbonac-jobs
    ports:
      - "3001:3001"
      - "3003:3001"
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: '1.0'
    healthcheck:
      test: ["CMD", "node", "scripts/redis-healthcheck.js"]
      interval: 30s
      timeout: 10s
      retries: 3
    volumes:
      - output-data:/app/output
      - temp-data:/app/temp
    profiles:
      - api
      - full

  worker:
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
      args:
        INSTALL_TYPST: "0"
        INSTALL_QUARTO: "0"
    container_name: carbonac-worker
    env_file:
      - .env
    environment:
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - JOB_QUEUE_NAME=carbonac-jobs
      - PUPPETEER_SKIP_DOWNLOAD=1
      - PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
      - WORKER_CONCURRENCY=${WORKER_CONCURRENCY:-1}
      - PDF_QA_ENABLED=${PDF_QA_ENABLED:-false}
    deploy:
      resources:
        limits:
          memory: 2g
          cpus: '2.0'
    healthcheck:
      test: ["CMD", "node", "backend/scripts/redis-healthcheck.js"]
      interval: 30s
      timeout: 10s
      retries: 3
    volumes:
      - output-data:/app/output
      - temp-data:/app/temp
    profiles:
      - worker
      - full

volumes:
  output-data:
  temp-data:
  redis-data:
