# docker-compose.yml â€” Unified Carbonac compose (profile-based)
#
# Usage:
#   Pi (Redis + API, production):
#     docker compose --env-file .env --env-file .env.pi --profile pi up -d
#
#   HP (Worker only, connects to Pi Redis):
#     docker compose --env-file .env --env-file .env.hp --profile hp-worker up -d
#
#   Full stack (all services, development):
#     docker compose --env-file .env --profile full up -d
#
#   Individual services:
#     docker compose --profile redis up -d
#     docker compose --profile api up -d
#     docker compose --profile worker up -d

services:
  redis:
    image: redis:7.2-alpine
    container_name: carbonac-redis
    command: ["redis-server", "/usr/local/etc/redis/redis.conf"]
    volumes:
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - redis-data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    deploy:
      resources:
        limits:
          memory: ${REDIS_MEMORY_LIMIT:-256m}
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    profiles:
      - redis
      - pi
      - full

  api:
    build:
      context: .
      dockerfile: docker/Dockerfile.api
    container_name: carbonac-api
    env_file:
      - .env
    environment:
      - PORT=3001
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - JOB_QUEUE_NAME=carbonac-jobs
    ports:
      - "${API_HOST_PORT:-3001}:3001"
    deploy:
      resources:
        limits:
          memory: ${API_MEMORY_LIMIT:-512m}
          cpus: '1.0'
    healthcheck:
      test: ["CMD", "node", "backend/scripts/redis-healthcheck.js"]
      interval: 30s
      timeout: 10s
      retries: 3
    volumes:
      - output-data:/app/output
      - temp-data:/app/temp
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    profiles:
      - api
      - pi
      - full

  worker:
    build:
      context: .
      dockerfile: docker/Dockerfile.worker
      args:
        INSTALL_TYPST: "0"
        INSTALL_QUARTO: "0"
    container_name: carbonac-worker
    env_file:
      - .env
    environment:
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - JOB_QUEUE_NAME=carbonac-jobs
      - PUPPETEER_SKIP_DOWNLOAD=1
      - PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
      - WORKER_CONCURRENCY=${WORKER_CONCURRENCY:-1}
      - PDF_QA_ENABLED=${PDF_QA_ENABLED:-false}
    deploy:
      resources:
        limits:
          memory: ${WORKER_MEMORY_LIMIT:-2g}
          cpus: '2.0'
    healthcheck:
      test: ["CMD", "node", "backend/scripts/redis-healthcheck.js"]
      interval: 30s
      timeout: 10s
      retries: 3
    volumes:
      - output-data:/app/output
      - temp-data:/app/temp
    restart: unless-stopped
    profiles:
      - worker
      - hp-worker
      - full

volumes:
  output-data:
  temp-data:
  redis-data:
